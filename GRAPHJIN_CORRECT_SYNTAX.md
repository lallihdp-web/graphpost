# GraphJin Aggregates - Correct Syntax for GraphPost

## ❌ What DOESN'T Work

GraphJin does **NOT** support Hasura-style `_aggregate` types:

```graphql
# ❌ THIS WILL FAIL
query {
  categories_aggregate {
    aggregate {
      count {
        id
      }
    }
  }
}
```

Error: `table not found: public.categories_aggregate`

## ✅ What DOES Work

GraphJin uses **inline aggregate fields** with prefix notation:

### Example 1: Count All Categories

```graphql
query {
  categories {
    count_id
  }
}
```

**Result:**
```json
{
  "data": {
    "categories": {
      "count_id": 3
    }
  }
}
```

### Example 2: Get All Categories with Count

```graphql
query {
  categories {
    id
    name
    description
  }
}
```

**Result:**
```json
{
  "data": {
    "categories": [
      {
        "id": 1,
        "name": "Technology",
        "description": "Tech-related posts"
      },
      {
        "id": 2,
        "name": "Travel",
        "description": "Travel stories and tips"
      },
      {
        "id": 3,
        "name": "Food",
        "description": "Recipes and restaurant reviews"
      }
    ]
  }
}
```

### Example 3: Count with Aggregates on Related Data

Count posts per category using the junction table:

```graphql
query {
  post_categories {
    category_id
    count_id
  }
}
```

This groups by `category_id` and counts posts per category.

### Example 4: Complex Aggregate Query

Get users with post counts:

```graphql
query {
  users {
    id
    name
    email
    posts {
      count_id
    }
  }
}
```

## Working Examples for Your Schema

Based on your `init.sql`, here are working aggregate queries:

### Count Total Users
```graphql
query {
  users {
    count_id
  }
}
```

### Count Total Posts
```graphql
query {
  posts {
    count_id
  }
}
```

### Count Published vs Unpublished Posts
```graphql
query PublishedPosts {
  posts(where: { published: { eq: true } }) {
    count_id
  }
}

query UnpublishedPosts {
  posts(where: { published: { eq: false } }) {
    count_id
  }
}
```

### Get Users with Their Post Counts
```graphql
query {
  users {
    id
    name
    posts {
      count_id
    }
  }
}
```

**Result:**
```json
{
  "data": {
    "users": [
      {
        "id": 1,
        "name": "Alice Johnson",
        "posts": {
          "count_id": 2
        }
      },
      {
        "id": 2,
        "name": "Bob Smith",
        "posts": {
          "count_id": 1
        }
      },
      {
        "id": 3,
        "name": "Charlie Brown",
        "posts": {
          "count_id": 1
        }
      }
    ]
  }
}
```

### Count Comments Per Post
```graphql
query {
  posts {
    id
    title
    comments {
      count_id
    }
  }
}
```

### Average Post ID (Numeric Aggregates)
```graphql
query {
  posts {
    count_id
    avg_id
    min_id
    max_id
  }
}
```

## GraphJin Aggregate Syntax Rules

1. **Prefix the function**: `count_`, `sum_`, `avg_`, `min_`, `max_`
2. **Use actual column names**: Use `count_id` not `countId`
3. **No separate _aggregate type**: Aggregates are inline with the query
4. **Automatic grouping**: When you mix regular fields with aggregates, GraphJin groups automatically

## Why You Saw `categories_aggregate`

If you saw `categories_aggregate` in the WebUI schema, it might be:

1. **Cached schema** from the legacy engine - restart the server
2. **Introspection confusion** - GraphJin generates the schema dynamically
3. **UI auto-completion** - The UI might suggest fields that don't exist

## Testing Your Setup

Try these queries in order to verify aggregates work:

**Step 1: Simple count**
```graphql
query {
  categories {
    count_id
  }
}
```

**Step 2: List with aggregates**
```graphql
query {
  users {
    name
    count_id
  }
}
```

This should group by name and show counts.

**Step 3: Nested aggregates**
```graphql
query {
  users {
    id
    name
    posts {
      count_id
    }
    comments {
      count_id
    }
  }
}
```

## SQL Translation

GraphJin converts these GraphQL queries to optimized SQL:

**GraphQL:**
```graphql
query {
  users {
    name
    posts {
      count_id
    }
  }
}
```

**SQL (Generated by GraphJin):**
```sql
SELECT
  users.name,
  (SELECT COUNT(posts.id)
   FROM posts
   WHERE posts.author_id = users.id) as posts_count_id
FROM users
```

## Configuration Check

Ensure your `config.json` has:

```json
{
  "graphjin": {
    "enabled": true,
    "production": false,
    "default_limit": 20,
    "disable_functions": false
  },
  "server": {
    "enable_introspection": true
  }
}
```

## Still Not Working?

If aggregates still don't work:

1. **Restart the server** - Schema cache needs refresh
2. **Check GraphJin is enabled** - Look for "✓ GraphJin engine initialized" in logs
3. **Verify config** - `disable_functions: false` (enables aggregates)
4. **Check table names** - Use plural forms (e.g., `users` not `user`)
5. **Try introspection query**:
   ```graphql
   query {
     __schema {
       queryType {
         fields {
           name
         }
       }
     }
   }
   ```

## References

- [GraphJin Query Documentation](https://graphjin.com/posts/query)
- [GraphJin Start Guide](https://graphjin.com/posts/start)
- [GraphJin GitHub](https://github.com/dosco/graphjin)
- [GraphJin Core Package](https://pkg.go.dev/github.com/dosco/graphjin/core)
